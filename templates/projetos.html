{% extends "base.html" %}

{% block content %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="fas fa-project-diagram"></i> Meus Projetos</h1>
        <a href="/logout" class="btn btn-danger">Logout</a>
    </div>

    <!-- Formulário de Filtros -->
    <form method="GET" action="/projetos" class="form-row align-items-end mb-4">
        <div class="form-group col-md-3">
            <label for="nome">Nome do Projeto:</label>
            <select class="form-control" id="nome" name="nome">
                <option value="">Todos</option>
                {% for projeto in projetos %}
                <option value="{{ projeto.nome }}" {% if request.args.get('nome', '' )==projeto.nome %}selected{% endif
                    %}>{{ projeto.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group col-md-2">
            <label for="status">Status da Tarefa:</label>
            <select class="form-control" id="status" name="status">
                <option value="">Todos</option>
                <option value="pendente" {% if request.args.get('status')=='pendente' %}selected{% endif %}>Pendente
                </option>
                <option value="em progresso" {% if request.args.get('status')=='em progresso' %}selected{% endif %}>Em
                    Progresso</option>
                <option value="concluída" {% if request.args.get('status')=='concluída' %}selected{% endif %}>Concluída
                </option>
            </select>
        </div>
        <div class="form-group col-md-2">
            <label for="data_inicio">Data de Início:</label>
            <input type="date" class="form-control" id="data_inicio" name="data_inicio"
                value="{{ request.args.get('data_inicio', '') }}">
        </div>
        <div class="form-group col-md-2">
            <label for="data_fim">Data de Término:</label>
            <input type="date" class="form-control" id="data_fim" name="data_fim"
                value="{{ request.args.get('data_fim', '') }}">
        </div>
        <div class="form-group col-md-4 d-flex align-items-end">
            <div class="w-100 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-auto px-3">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
                <button type="button" class="btn btn-outline-secondary w-auto px-3" id="limpar-filtros">
                    <i class="fas fa-eraser"></i> Limpar Filtros
                </button>
            </div>
        </div>
    </form>

    <div class="mb-4 text-right">
        <a href="/projetos/criar" class="btn btn-success">
            <i class="fas fa-plus"></i> Novo Projeto
        </a>
    </div>

    {% if projetos %}
    <div class="row">
        {% for projeto in projetos %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-project-diagram"></i> {{ projeto.nome }}</h5>
                    <span
                        class="badge {% if projeto.status == 'Concluído' %}badge-success{% else %}badge-warning{% endif %}">
                        {{ projeto.status or 'Sem status' }}
                    </span>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2"><i class="fas fa-align-left"></i> {{ projeto.descricao or 'Sem descrição'
                        }}</p>
                    <div class="mb-2">
                        <i class="fas fa-calendar"></i> <strong>Início:</strong> {{ projeto.data_inicio or 'Não
                        definida' }}<br>
                        <i class="fas fa-calendar-check"></i> <strong>Término:</strong> {{ projeto.data_fim or 'Não
                        definida' }}
                    </div>
                </div>
                <div class="card-footer bg-white border-0 d-flex justify-content-between">
                    <div class="btn-group" role="group">
                        <a href="/projetos/{{ projeto.id }}" class="btn btn-info btn-sm" title="Ver Detalhes">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="/projetos/editar/{{ projeto.id }}" class="btn btn-warning btn-sm" title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="/projetos/excluir/{{ projeto.id }}"
                            onclick="return confirm('Tem certeza que deseja excluir?')" class="btn btn-danger btn-sm"
                            title="Excluir">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info text-center">
        <i class="fas fa-info-circle fa-2x mb-3"></i>
        <h5>Nenhum projeto encontrado</h5>
        <p>Você não tem projetos cadastrados ou não há projetos com os filtros selecionados.</p>
    </div>
    {% endif %}

    <!-- Gantt geral no final da página -->
    <div class="card mb-4 mt-5">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-chart-bar"></i> Gantt Geral de Todos os Projetos
        </div>
        <div class="card-body">
            <div class="controls mb-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-2">Visualização:</h6>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeView('Day')">Dia</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeView('Week')">Semana</button>
                        <button class="btn btn-outline-primary btn-sm active" onclick="changeView('Month')">Mês</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeView('Year')">Ano</button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary btn-sm" onclick="today()">
                            <i class="fas fa-calendar-day me-1"></i>Hoje
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="prev()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="next()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="gantt_geral" style="width:100%; height:400px;"></div>
            <div class="legend mt-3">
                <div class="legend-item">
                    <div class="legend-color status-pendente"></div>
                    <span>Pendente</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color status-em-progresso"></div>
                    <span>Em Progresso</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color status-concluida"></div>
                    <span>Concluída</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- jQuery deve vir antes do Select2 e de qualquer uso de $ -->
<style>
    /* Estilo similar ao Power BI para Frappe Gantt */
    .gantt .bar {
        fill: #667eea;
        stroke: #5a6fd8;
        stroke-width: 1;
        rx: 4;
        ry: 4;
    }
    
    .gantt .bar-progress {
        fill: #764ba2;
    }
    
    .gantt .grid-header {
        fill: #667eea;
        stroke: #5a6fd8;
    }
    
    .gantt .grid-row {
        fill: white;
        stroke: #e9ecef;
    }
    
    .gantt .grid-row:nth-child(even) {
        fill: #f8f9fa;
    }
    
    .gantt .arrow {
        fill: none;
        stroke: #667eea;
        stroke-width: 2;
    }
    
    .gantt .arrow:hover {
        stroke: #764ba2;
        stroke-width: 3;
    }
    
    .gantt .today-highlight {
        fill: rgba(255, 193, 7, 0.2);
    }
    
    .gantt .weekend-highlight {
        fill: rgba(220, 53, 69, 0.1);
    }
    
    .gantt .grid-header-cell {
        fill: #667eea;
        stroke: #5a6fd8;
        font-weight: 600;
        font-size: 12px;
    }
    
    .gantt .grid-header-cell text {
        fill: white;
    }
    
    .gantt .lower-text, .gantt .upper-text {
        font-size: 12px;
        font-weight: 500;
    }
    
    .gantt .lower-text {
        fill: #6c757d;
    }
    
    .gantt .upper-text {
        fill: #495057;
    }
    
    .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #495057;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
    
    .status-pendente { background-color: #ffc107; }
    .status-em-progresso { background-color: #17a2b8; }
    .status-concluida { background-color: #28a745; }
    
    .controls {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .btn-outline-primary.active {
        background-color: #667eea;
        border-color: #667eea;
        color: white;
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.css">
<script src="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<script>
    $(document).ready(function () {
        $('#nome').select2({
            placeholder: 'Selecione ou digite o nome do projeto',
            allowClear: true,
            width: '100%'
        });
        $('#limpar-filtros').on('click', function () {
            // Limpa todos os campos do formulário
            $(this).closest('form')[0].reset();
            // Limpa o select2
            $('#nome').val('').trigger('change');
        });
    });

    // ====== FRAPPE GANTT CONFIGURAÇÃO ======
    let gantt;

    // Funções de controle do Gantt
    function changeView(mode) {
        // Remove active class de todos os botões
        document.querySelectorAll('.btn-outline-primary').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Adiciona active class ao botão clicado
        event.target.classList.add('active');
        
        gantt.change_view_mode(mode);
    }

    function today() {
        gantt.today();
    }

    function prev() {
        gantt.prev();
    }

    function next() {
        gantt.next();
    }

    // Função para converter dados para Frappe Gantt
    function converterDadosParaFrappe(dadosGantt) {
        const tarefas = [];
        
        dadosGantt.forEach(item => {
            tarefas.push({
                id: item.id,
                name: item.name || 'Tarefa sem nome',
                start: item.start || '2025-01-01',
                end: item.end || '2025-01-01',
                progress: item.progress || 0,
                dependencies: item.dependencies || '',
                custom_class: item.custom_class || 'status-pendente'
            });
        });
        
        return tarefas;
    }

    // Inicializar o Gantt quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        const ganttGeralDiv = document.getElementById('gantt_geral');
        
        if (ganttGeralDiv && typeof Gantt !== 'undefined') {
            // Converter dados do formato dhtmlxGantt para Frappe Gantt
            const dadosGantt = {{ gantt_geral_data | tojson | safe }};
            
            // Função para validar datas
            function isValidDate(dateStr) {
                const d = new Date(dateStr);
                return !isNaN(d) && dateStr === d.toISOString().slice(0, 10);
            }
            
            // Filtrar tarefas com datas válidas
            let tarefas = converterDadosParaFrappe(dadosGantt).filter(
                t => t.start && t.end && 
                     typeof t.start === 'string' && 
                     typeof t.end === 'string' &&
                     t.start.match(/^\d{4}-\d{2}-\d{2}$/) &&
                     t.end.match(/^\d{4}-\d{2}-\d{2}$/) &&
                     t.start !== 'None' && t.end !== 'None' &&
                     t.start !== '' && t.end !== ''
            );
            
            // Remover tarefas com IDs duplicados
            const seenIds = new Set();
            tarefas = tarefas.filter(t => {
                if (seenIds.has(t.id)) return false;
                seenIds.add(t.id);
                return true;
            });
            
            // Filtrar tarefas com datas válidas
            tarefas = tarefas.filter(t => 
                new Date(t.start) <= new Date(t.end) && 
                isValidDate(t.start) && 
                isValidDate(t.end)
            );
            
            // Se não houver tarefas, criar dados de exemplo
            if (tarefas.length === 0) {
                tarefas = [
                    {
                        id: '1',
                        name: 'Tarefa de Exemplo 1',
                        start: '2025-01-01',
                        end: '2025-01-15',
                        progress: 50,
                        dependencies: '',
                        custom_class: 'status-em-progresso'
                    },
                    {
                        id: '2',
                        name: 'Tarefa de Exemplo 2',
                        start: '2025-01-10',
                        end: '2025-01-25',
                        progress: 30,
                        dependencies: '1',
                        custom_class: 'status-pendente'
                    }
                ];
            }
            
            try {
                // Inicializar o Frappe Gantt
                gantt = new Gantt("#gantt_geral", tarefas, {
                    view_mode: 'Month',
                    date_format: 'YYYY-MM-DD',
                    show_progress: true,
                    show_arrows: true,
                    show_today: true,
                    show_weekends: true,
                    language: 'pt',
                    on_click: function (task) {
                        console.log('Tarefa clicada:', task);
                    },
                    on_date_change: function (task, start, end) {
                        console.log('Data alterada:', task, start, end);
                    },
                    on_progress_change: function (task, progress) {
                        console.log('Progresso alterado:', task, progress);
                    }
                });
            } catch (error) {
                console.error('Erro ao inicializar Frappe Gantt:', error);
                ganttGeralDiv.innerHTML = '<p style="color: red;">Erro ao inicializar Gantt: ' + error.message + '</p>';
            }
        }
    });
</script>
{% endblock %}