{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="fas fa-project-diagram"></i> Meus Projetos</h1>
        <a href="/logout" class="btn btn-danger">Logout</a>
    </div>

    <!-- Formulário de Filtros (importado de projetos.html) -->
    <form method="GET" action="/projetos" class="form-row align-items-end mb-4">
        <div class="form-group col-md-3">
            <label for="nome">Nome do Projeto:</label>
            <select class="form-control" id="nome" name="nome">
                <option value="">Todos</option>
                {% for projeto in projetos %}
                <option value="{{ projeto.nome }}" {% if request.args.get('nome', '' )==projeto.nome %}selected{% endif
                    %}>{{ projeto.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group col-md-2">
            <label for="status">Status da Tarefa:</label>
            <select class="form-control" id="status" name="status">
                <option value="">Todos</option>
                <option value="pendente" {% if request.args.get('status')=='pendente' %}selected{% endif %}>Pendente
                </option>
                <option value="em progresso" {% if request.args.get('status')=='em progresso' %}selected{% endif %}>Em
                    Progresso</option>
                <option value="concluída" {% if request.args.get('status')=='concluída' %}selected{% endif %}>Concluída
                </option>
            </select>
        </div>
        <div class="form-group col-md-3">
            <label for="colecao"><i class="fas fa-layer-group"></i> Coleções:</label>
            <select class="form-control" id="colecao" name="colecao" multiple="multiple" style="width: 100%;">
                {% if colecoes %}
                {% for colecao in colecoes %}
                <option value="{{ colecao }}" {% if colecao in request.args.getlist('colecao') %}selected{% endif %}>{{
                    colecao }}</option>
                {% endfor %}
                {% endif %}
            </select>
        </div>
        <div class="form-group col-md-2">
            <label for="data_inicio">Data de Início:</label>
            <input type="date" class="form-control" id="data_inicio" name="data_inicio"
                value="{{ request.args.get('data_inicio', '') }}">
        </div>
        <div class="form-group col-md-2">
            <label for="data_fim">Data de Término:</label>
            <input type="date" class="form-control" id="data_fim" name="data_fim"
                value="{{ request.args.get('data_fim', '') }}">
        </div>
        <div class="form-group col-md-4 d-flex align-items-end">
            <div class="w-100 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-auto px-3">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
                <button type="button" class="btn btn-outline-secondary w-auto px-3" id="limpar-filtros">
                    <i class="fas fa-eraser"></i> Limpar Filtros
                </button>
            </div>
        </div>
    </form>

    {% if projetos %}
    <div class="row">
        {% for projeto in projetos %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-project-diagram"></i> {{ projeto.nome }}</h5>
                    <span
                        class="badge {% if projeto.status == 'Concluído' %}badge-success{% else %}badge-warning{% endif %}">
                        {{ projeto.status or 'Sem status' }}
                    </span>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2"><i class="fas fa-align-left"></i> {{ projeto.descricao or 'Sem descrição'
                        }}</p>
                    <div class="mb-2">
                        <i class="fas fa-calendar"></i> <strong>Início:</strong> {{ projeto.data_inicio or 'Não
                        definida' }}<br>
                        <i class="fas fa-calendar-check"></i> <strong>Término:</strong> {{ projeto.data_fim or 'Não
                        definida' }}
                    </div>
                    <hr class="my-2">
                    <div>
                        <strong>Tarefas deste projeto:</strong>
                        {% if projeto.tarefas and projeto.tarefas|length > 0 %}
                            <ul class="list-group list-group-flush mb-0">
                                {% for tarefa in projeto.tarefas %}
                                <li class="list-group-item px-0 py-1 d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-tasks"></i> {{ tarefa.nome }}
                                        <small class="text-muted">({{ tarefa.data_inicio or '-' }} a {{ tarefa.data_fim or '-' }})</small>
                                    </span>
                                    <span class="badge 
                                        {% if tarefa.status == 'pendente' %}bg-warning text-dark
                                        {% elif tarefa.status == 'em progresso' %}bg-info text-dark
                                        {% elif tarefa.status == 'concluída' %}bg-success
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {{ tarefa.status|capitalize if tarefa.status else 'Sem status' }}
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="text-muted small">Nenhuma tarefa encontrada para este filtro.</div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-white border-0 d-flex justify-content-between">
                    <div class="btn-group" role="group">
                        <a href="/projetos/{{ projeto.id }}" class="btn btn-info btn-sm" title="Ver Detalhes">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="/projetos/editar/{{ projeto.id }}" class="btn btn-warning btn-sm" title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="/projetos/excluir/{{ projeto.id }}"
                            onclick="return confirm('Tem certeza que deseja excluir?')" class="btn btn-danger btn-sm"
                            title="Excluir">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info text-center">
        <i class="fas fa-info-circle fa-2x mb-3"></i>
        <h5>Nenhum projeto encontrado</h5>
        <p>Você não tem projetos cadastrados.</p>
    </div>
    {% endif %}

    <!-- Gantt agrupado estilo teste_agrupamento_gantt.html -->
    <div class="card mb-4 mt-5">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-chart-bar"></i> Cronograma de Tarefas
            </div>
                </div>
        <div class="card-body">
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 8px; gap: 8px;">
                <button id="zoom-out" class="btn btn-outline-secondary btn-sm" title="Diminuir Zoom"
                    style="font-size: 1.2em;">-</button>
                <span id="zoom-label" style="min-width: 40px; text-align: center;">100%</span>
                <button id="zoom-in" class="btn btn-outline-secondary btn-sm" title="Aumentar Zoom"
                    style="font-size: 1.2em;">+</button>
                </div>
            <div id="gantt-custom" style="width: 100%; overflow-x: auto;">
                <div style="display: flex; flex-direction: column;">
                    <div style="display: flex;">
                        <div style="width: 320px; min-width: 320px; max-width: 320px;"></div>
                        <div id="gantt-date-header" style="flex: 1; position: relative;"></div>
                </div>
            </div>
                <div id="gantt-cronograma-area" style="position: relative;">
                    <div id="gantt-hoje-container"></div>
                    <table style="border-collapse: collapse; width: 100%;">
                        <thead>
                            <tr>
                                <th
                                    style="width: 320px; min-width: 320px; max-width: 320px; text-align: left; padding: 8px;">
                                    Tarefa</th>
                                <th style="text-align: left; padding: 8px;"></th>
                            </tr>
                        </thead>
                        <tbody id="gantt-body"></tbody>
                    </table>
        </div>
            </div>
            <!-- Legenda colorida por projeto -->
            <div class="legend mt-2"
                style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; align-items: center;">
                {% for projeto, cor in projects_colors.items() %}
                <div class="legend-item"
                    style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #495057; cursor: pointer;"
                    data-projeto="{{ projeto }}">
                    <div class="legend-color"
                        style="width: 16px; height: 16px; border-radius: 3px; background-color: {{ cor }};"></div>
                    <span>{{ projeto }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Select2 para o campo de nome do projeto -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('#nome').select2({
            placeholder: 'Selecione ou digite o nome do projeto',
            allowClear: true,
            width: '100%'
        });
        $('#colecao').select2({
            placeholder: 'Filtrar por coleção',
            allowClear: true,
            width: '100%',
            theme: 'bootstrap-5',
            closeOnSelect: false
        });
        $('#limpar-filtros').on('click', function () {
            // Limpa todos os campos do formulário
            $(this).closest('form')[0].reset();
            // Limpa o select2
            $('#nome').val('').trigger('change');
            $('#colecao').val('').trigger('change'); // Limpa múltiplos selects
        });
    });
</script>
<style>
.gantt-header {
    display: flex;
    border-bottom: 2px solid #dee2e6;
    background: #f8f9fa;
    font-weight: bold;
}

.gantt-header-cell {
    padding: 10px;
    text-align: center;
    border-right: 1px solid #dee2e6;
    min-width: 100px;
    transition: min-width 0.3s ease;
}

.gantt-day {
    padding: 10px;
    border-right: 1px solid #dee2e6;
    min-width: 100px;
    text-align: center;
    position: relative;
    transition: min-width 0.3s ease;
}

.gantt-controls .btn-group {
    margin-left: 5px;
}

.gantt-controls .btn {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

.gantt-controls .btn.active {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
}

.gantt-row {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    min-height: 40px;
}

.gantt-row:nth-child(even) {
    background: #f8f9fa;
}

    .gantt-task-name,
    td[style*='min-width: 200px'] {
        font-size: 13px !important;
}

.gantt-task-bar {
    position: absolute;
    height: 20px;
    background: #007bff;
    border-radius: 3px;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s;
    z-index: 10;
    opacity: 1;
}

.gantt-task-bar:hover {
    background: #0056b3;
}

/* Tooltip personalizado */
.gantt-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 12px;
    border-radius: 6px;
    font-size: 12px;
    max-width: 300px;
    z-index: 9999;
    pointer-events: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.gantt-tooltip::before {
    content: '';
    position: absolute;
    top: -5px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-bottom: 5px solid rgba(0, 0, 0, 0.9);
}

.gantt-tooltip-title {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 8px;
    color: #fff;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    padding-bottom: 4px;
}

.gantt-tooltip-project {
    color: #ffd700;
    font-weight: 500;
    margin-bottom: 6px;
}

.gantt-tooltip-info {
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
}

.gantt-tooltip-label {
    color: #ccc;
    font-size: 11px;
}

.gantt-tooltip-value {
    color: #fff;
    font-weight: 500;
    text-align: right;
}

.gantt-tooltip-days {
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.gantt-tooltip-days .gantt-tooltip-info {
    margin-bottom: 2px;
}

    .gantt-task-bar.pendente {
        background: #ffc107;
    }

    .gantt-task-bar.em-progresso {
        background: #17a2b8;
    }

    .gantt-task-bar.concluida {
        background: #28a745;
    }

.gantt-day {
    padding: 10px;
    border-right: 1px solid #dee2e6;
    min-width: 100px;
    text-align: center;
    position: relative;
}

.gantt-today {
    background: rgba(255, 193, 7, 0.2);
    font-weight: bold;
}

.gantt-weekend {
    background: rgba(220, 53, 69, 0.1);
}

#gantt-timeline {
    position: relative;
    min-width: 800px;
    background: #fff;
    overflow: visible;
}

.gantt-task-bar {
    position: absolute;
    height: 20px;
    background: #007bff;
    border-radius: 3px;
    margin-top: 10px;
    cursor: pointer;
    transition: background 0.3s;
    z-index: 10;
    opacity: 1;
}

.gantt-task-bar:hover {
    background: #0056b3;
}

    /* Coluna fixa para Tarefa */
    #gantt-custom th:first-child,
    #gantt-custom td:first-child {
        position: sticky;
        left: 0;
        background: #fff;
        z-index: 50;
        /* aumentado para garantir sobreposição */
        width: 320px;
        min-width: 320px;
        max-width: 320px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Cabeçalho de meses e dias do Gantt */
    #gantt-date-header {
        font-family: inherit;
    }

    /* CSS extra para centralizar e aumentar altura do cabeçalho */
    .gantt-dia-cell {
        font-size: 11px;
        color: #888;
        background: #f8f9fa;
        border-right: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 20px;
    }

    .gantt-hoje-linha {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: repeating-linear-gradient(to bottom,
                #e74c3c 0px, #e74c3c 8px,
                transparent 8px, transparent 16px);
        z-index: 5;
        /* reduzido para ficar atrás da coluna fixa */
        pointer-events: none;
    }

    #gantt-hoje-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
    }

    #gantt-cronograma-area {
        position: relative;
    }

    .gantt-row-compact {
        height: 32px !important;
    }

    .gantt-bar-compact {
        height: 18px !important;
        line-height: 18px !important;
        font-size: 11px !important;
        top: 7px !important;
    }

    .gantt-tooltip-detalhado {
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 12px;
        border-radius: 6px;
        font-size: 12px;
        max-width: 300px;
        z-index: 1000;
        pointer-events: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .gantt-tooltip-detalhado .gantt-tooltip-title {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 8px;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        padding-bottom: 4px;
    }

    .gantt-tooltip-detalhado .gantt-tooltip-info {
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
    }

    .gantt-tooltip-detalhado .gantt-tooltip-label {
        color: #ccc;
        font-size: 11px;
    }

    .gantt-tooltip-detalhado .gantt-tooltip-value {
        color: #fff;
        font-weight: 500;
        text-align: right;
    }

    .gantt-row-compact td,
    .gantt-row-compact th {
        height: 24px !important;
        min-height: 24px !important;
        max-height: 24px !important;
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        font-size: 13px !important;
    }

    .gantt-h-linha {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 1px;
        background: #dee2e6;
        z-index: 0;
        /* reduzido para ficar atrás da coluna fixa */
    }

    .gantt-bar-compact.evidencia {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 20;
        opacity: 1 !important;
        border: none !important;
    }

    .gantt-bar-compact.apagada {
        opacity: 0.25 !important;
        filter: grayscale(0.5);
    }

    .legend-item.selecionada {
        outline: 2px solid #222;
        outline-offset: 2px;
        background: #f3f3f3;
        border-radius: 5px;
    }

    #gantt-custom.dragging {
        cursor: grabbing !important;
        user-select: none !important;
    }

    .form-row.align-items-end.mb-4 {
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px !important;
    }

    #colecao+.select2-container--bootstrap-5 .select2-selection--multiple {
        min-height: 32px;
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        background: #fff;
        font-size: 0.95rem;
        padding: 0.1rem 0.3rem;
    }

    #colecao+.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
        background: #0d6efd;
        color: #fff;
        border: none;
        border-radius: 0.25rem;
        padding: 0.05em 0.4em;
        margin-top: 0.1em;
        font-size: 0.92em;
        line-height: 1.2em;
    }

    #colecao+.select2-container--bootstrap-5 .select2-selection--multiple .select2-search__field {
        font-size: 0.95rem;
        min-width: 60px;
    }

    .form-group.col-md-3,
    .form-group.col-md-2 {
        margin-bottom: 0.5rem;
    }
</style>

<script>
    window.ganttData = {{ gantt_geral_data | tojson | safe }};
</script>

<script>
    const larguraBase = 4; // 100% = 4px
    let larguraDia = larguraBase;
    const larguraMin = 1;
    const larguraMax = 32;
    const ROW_HEIGHT = 32; // altura de cada linha (ajuste conforme seu CSS)
    const VISIBLE_ROWS = 18; // quantas linhas mostrar de cada vez (ajuste conforme altura do container)
    let tarefas = [];
    let nomesOrdenados = [];
    let grupos = {};
    let periodo = { min: null, max: null };
    let diasTotais = 0;

    // Função utilitária para agrupar tarefas por nome
    function agruparTarefasPorNome(tarefas) {
        const grupos = {};
        tarefas.forEach(tarefa => {
            if (!grupos[tarefa.name]) grupos[tarefa.name] = [];
            grupos[tarefa.name].push(tarefa);
        });
        return grupos;
    }

    // Função para obter datas mínimas e máximas
    function obterPeriodo(tarefas) {
        let min = null, max = null;
        tarefas.forEach(t => {
            const ini = new Date(t.start);
            const fim = new Date(t.end);
            if (!min || ini < min) min = ini;
            if (!max || fim > max) max = fim;
        });
        return { min, max };
    }

    // Função para calcular dias entre datas
    function diasEntre(a, b) {
        return Math.ceil((b - a) / (1000 * 60 * 60 * 24));
    }

    // Função para cor de status
    function corStatus(tarefa) {
        if (tarefa.bar_color) return tarefa.bar_color;
        if (tarefa.status === 'concluida') return '#28a745';
        if (tarefa.status === 'em-progresso' || tarefa.status === 'em_progresso') return '#17a2b8';
        return '#ffc107';
    }

    // Função para tooltip
    function tooltipBarra(tarefa) {
        const ini = new Date(tarefa.start).toLocaleDateString('pt-BR');
        const fim = new Date(tarefa.end).toLocaleDateString('pt-BR');
        return `${tarefa.projeto_origem || tarefa.projeto_nome || ''}: ${ini} a ${fim}`;
    }

    function calcularDiasUteis(dataInicio, dataFim) {
        let diasUteis = 0;
        const dataAtual = new Date(dataInicio);
        while (dataAtual <= dataFim) {
            if (dataAtual.getDay() !== 0 && dataAtual.getDay() !== 6) {
                diasUteis++;
            }
            dataAtual.setDate(dataAtual.getDate() + 1);
        }
        return diasUteis;
    }

    function mostrarTooltipDetalhado(event, barra) {
        esconderTooltipDetalhado();
        const startDate = new Date(barra.start);
        const endDate = new Date(barra.end);
        const diasCorridos = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        const diasUteis = calcularDiasUteis(startDate, endDate);
        const diasUteisTexto = diasUteis === 1 ? 'dia' : 'dias';
        const tooltip = document.createElement('div');
        tooltip.className = 'gantt-tooltip-detalhado';
        tooltip.id = 'gantt-tooltip-detalhado';
        const dataInicio = startDate.toLocaleDateString('pt-BR');
        const dataFim = endDate.toLocaleDateString('pt-BR');
        const nomeProjeto = barra.projeto_origem || barra.projeto_nome || 'Projeto não definido';
        tooltip.innerHTML = `
            <div class=\"gantt-tooltip-title\">${barra.name || 'Tarefa sem nome'}</div>
            <div style=\"color:#ffd700;font-size:11px;margin-bottom:6px;line-height:1.2;\">${nomeProjeto}</div>
            <div style=\"color:#007bff;font-size:11px;margin-bottom:6px;line-height:1.2;\"><b>Coleção:</b> ${barra.colecao || '-'} </div>
            <div class=\"gantt-tooltip-info\" style=\"gap: 12px;\">
                <span class=\"gantt-tooltip-label\">🏁 Início:</span>
                <span class=\"gantt-tooltip-value\">${dataInicio}</span>
                <span class=\"gantt-tooltip-label\">🎯 Fim:</span>
                <span class=\"gantt-tooltip-value\">${dataFim}</span>
            </div>
            <div class=\"gantt-tooltip-info\">
                <span class=\"gantt-tooltip-label\">📆 Dias Corridos:</span>
                <span class=\"gantt-tooltip-value\">${diasCorridos} dias</span>
            </div>
            <div class=\"gantt-tooltip-info\">
                <span class=\"gantt-tooltip-label\">📆 Dias Úteis:</span>
                <span class=\"gantt-tooltip-value\">${diasUteis} ${diasUteisTexto}</span>
            </div>
        `;
        document.body.appendChild(tooltip);
        atualizarPosicaoTooltipDetalhado(event);
    }

    function esconderTooltipDetalhado() {
        const tooltip = document.getElementById('gantt-tooltip-detalhado');
        if (tooltip) tooltip.remove();
}

    function atualizarPosicaoTooltipDetalhado(event) {
        const tooltip = document.getElementById('gantt-tooltip-detalhado');
    if (tooltip) {
            const tooltipRect = tooltip.getBoundingClientRect();
            let left = event.clientX + 12;
            let top = event.clientY + 12;
            if (left + tooltipRect.width > window.innerWidth) {
                left = window.innerWidth - tooltipRect.width - 8;
            }
            if (top + tooltipRect.height > window.innerHeight) {
                top = window.innerHeight - tooltipRect.height - 8;
            }
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }
    }

    // Função principal para montar o Gantt (sem virtualização)
    function montarGanttAgrupado() {
        const dados = window.ganttData || [];
        const body = document.getElementById('gantt-body');
        if (body) body.innerHTML = '<tr><td colspan="2">Carregando...</td></tr>';
        if (!dados.length) {
            if (body) body.innerHTML = '<tr><td colspan="2">Nenhuma tarefa para exibir.</td></tr>';
            return;
        }
        const tarefas = dados.filter(t => !t.type || t.type !== 'project');
        tarefas.sort((a, b) => (a.ordem ?? 0) - (b.ordem ?? 0));
        const grupos = agruparTarefasPorNome(tarefas);
        const nomesOrdenados = Object.keys(grupos).sort((a, b) => {
            const ordemA = Math.min(...grupos[a].map(t => t.ordem ?? 0));
            const ordemB = Math.min(...grupos[b].map(t => t.ordem ?? 0));
            return ordemA - ordemB;
        });
        const periodo = obterPeriodo(tarefas);
        if (!periodo.min || !periodo.max || isNaN(periodo.min) || isNaN(periodo.max)) {
            if (body) body.innerHTML = '<tr><td colspan="2">Período inválido para o Gantt.</td></tr>';
            return;
        }
        const diasTotais = Math.max(0, diasEntre(periodo.min, periodo.max));
        // Linha de hoje, cabeçalhos, etc (igual ao seu código)
        const hojeContainer = document.getElementById('gantt-hoje-container');
        if (hojeContainer) {
            hojeContainer.innerHTML = '';
            hojeContainer.style.position = 'absolute';
            hojeContainer.style.top = '0';
            hojeContainer.style.left = '0';
            hojeContainer.style.bottom = '0';
            hojeContainer.style.right = '0';
            hojeContainer.style.zIndex = '10';
            hojeContainer.style.pointerEvents = 'none';
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            if (hoje >= periodo.min && hoje <= periodo.max) {
                const offset = diasEntre(periodo.min, hoje);
                const left = 320 + (offset * larguraDia); // 320px da coluna tarefa
                const linhaHoje = document.createElement('div');
                linhaHoje.className = 'gantt-hoje-linha';
                linhaHoje.style.left = left + 'px';
                linhaHoje.style.height = '100%';
                hojeContainer.appendChild(linhaHoje);
            }
        }
        // Cabeçalho de datas de um nível (apenas dias)
        const dateHeader = document.getElementById('gantt-date-header');
        if (dateHeader) {
            dateHeader.innerHTML = '';
            // Espaço à esquerda para alinhar com a coluna Tarefa
            const espacoTarefa = document.createElement('div');
            espacoTarefa.style.width = '320px';
            espacoTarefa.style.minWidth = '320px';
            espacoTarefa.style.maxWidth = '320px';
            espacoTarefa.style.display = 'inline-block';
            espacoTarefa.style.height = '38px';
            espacoTarefa.style.background = 'transparent';
            dateHeader.appendChild(espacoTarefa);
            // Não renderizar mais os dias
        }
        // Renderizar todas as linhas de uma vez
        body.innerHTML = '';
        const fragment = document.createDocumentFragment();
        nomesOrdenados.forEach((nome, idx) => {
            const barras = grupos[nome];
            const tr = document.createElement('tr');
            tr.className = 'gantt-row-compact';
            // Nome da tarefa
            const tdNome = document.createElement('td');
            tdNome.textContent = nome;
            tdNome.title = nome;
            tdNome.style.padding = "2px 8px";
            tdNome.style.whiteSpace = "nowrap";
            tdNome.style.overflow = "hidden";
            tdNome.style.textOverflow = "ellipsis";
            tdNome.style.height = "24px";
            tdNome.style.fontSize = "13px";
            tr.appendChild(tdNome);
            // Cronograma
            const tdCrono = document.createElement('td');
            tdCrono.style.position = "relative";
            tdCrono.style.height = "24px";
            tdCrono.style.background = "#f8f9fa";
            tdCrono.style.minWidth = (diasTotais * larguraDia) + "px";
            // Adicionar linha horizontal de grade
            const linhaH = document.createElement('div');
            linhaH.className = 'gantt-h-linha';
            linhaH.style.position = 'absolute';
            linhaH.style.left = '0';
            linhaH.style.right = '0';
            linhaH.style.bottom = '0';
            linhaH.style.height = '1px';
            linhaH.style.background = '#dee2e6';
            linhaH.style.zIndex = '1';
            tdCrono.appendChild(linhaH);
            barras.forEach((barra, idx) => {
                const inicio = new Date(barra.start);
                const fim = new Date(barra.end);
                const offset = diasEntre(periodo.min, inicio);
                const largura = diasEntre(inicio, fim) + 1;
                const div = document.createElement('div');
                div.className = 'gantt-bar-compact';
                div.style.position = "absolute";
                div.style.left = (offset * larguraDia) + "px";
                div.style.top = "3px";
                div.style.height = "14px";
                div.style.width = (largura * larguraDia) + "px";
                div.style.background = corStatus(barra);
                div.style.borderRadius = "4px";
                div.style.textAlign = "center";
                div.style.color = "#fff";
                div.style.fontSize = "11px";
                div.style.lineHeight = "14px";
                div.style.cursor = "pointer";
                div.setAttribute('data-projeto', barra.projeto_origem || barra.projeto_nome || '');
                tdCrono.appendChild(div);
                div.onmouseenter = function (e) {
                    mostrarTooltipDetalhado(e, barra);
                    this._mousemoveHandler = function (ev) {
                        atualizarPosicaoTooltipDetalhado(ev);
                    };
                    this.addEventListener('mousemove', this._mousemoveHandler);
                };
                div.onmouseleave = function () {
                    esconderTooltipDetalhado();
                    if (this._mousemoveHandler) {
                        this.removeEventListener('mousemove', this._mousemoveHandler);
                        this._mousemoveHandler = null;
                    }
                };
            });
            tr.appendChild(tdCrono);
            fragment.appendChild(tr);
        });
        body.appendChild(fragment);
    }

    // Evento de scroll para atualizar as linhas visíveis
    document.addEventListener('DOMContentLoaded', function () {
        montarGanttAgrupado();
        function atualizarZoomLabel() {
            const zoomLabel = document.getElementById('zoom-label');
            if (zoomLabel) {
                const percent = Math.round((larguraDia / larguraBase) * 100);
                zoomLabel.textContent = percent + '%';
            }
        }
        atualizarZoomLabel();
        document.getElementById('zoom-in').onclick = function () {
            if (larguraDia < larguraMax) {
                larguraDia += larguraBase * 0.1;
                if (larguraDia > larguraMax) larguraDia = larguraMax;
                montarGanttAgrupado();
                atualizarZoomLabel();
            }
        };
        document.getElementById('zoom-out').onclick = function () {
            if (larguraDia > larguraMin) {
                larguraDia -= larguraBase * 0.1;
                if (larguraDia < larguraMin) larguraDia = larguraMin;
                montarGanttAgrupado();
                atualizarZoomLabel();
            }
        };

        // Evidenciar barras ao clicar na legenda (agora com seleção múltipla via Ctrl)
        let projetosSelecionados = [];
        document.querySelectorAll('.legend-item[data-projeto]').forEach(item => {
            item.addEventListener('click', function (e) {
                const projeto = this.getAttribute('data-projeto');
                const ctrl = e.ctrlKey || e.metaKey; // metaKey para Mac
                if (ctrl) {
                    // Seleção múltipla
                    if (projetosSelecionados.includes(projeto)) {
                        projetosSelecionados = projetosSelecionados.filter(p => p !== projeto);
                    } else {
                        projetosSelecionados.push(projeto);
                    }
                } else {
                    // Seleção única
                    if (projetosSelecionados.length === 1 && projetosSelecionados[0] === projeto) {
                        projetosSelecionados = [];
                    } else {
                        projetosSelecionados = [projeto];
                    }
                }
                // Atualizar barras
                if (projetosSelecionados.length === 0) {
                    document.querySelectorAll('.gantt-bar-compact').forEach(bar => {
                        bar.classList.remove('evidencia', 'apagada');
                    });
                    document.querySelectorAll('.legend-item').forEach(l => l.classList.remove('selecionada'));
                } else {
                    document.querySelectorAll('.gantt-bar-compact').forEach(bar => {
                        if (projetosSelecionados.includes(bar.getAttribute('data-projeto'))) {
                            bar.classList.add('evidencia');
                            bar.classList.remove('apagada');
                        } else {
                            bar.classList.remove('evidencia');
                            bar.classList.add('apagada');
                        }
                    });
                    document.querySelectorAll('.legend-item').forEach(l => {
                        const p = l.getAttribute('data-projeto');
                        if (projetosSelecionados.includes(p)) {
                            l.classList.add('selecionada');
                        } else {
                            l.classList.remove('selecionada');
                        }
                    });
                }
            });
        });
    });

    // Sincronizar scroll horizontal do cabeçalho e do corpo do Gantt
    const ganttCustom = document.getElementById('gantt-custom');
    const dateHeader = document.getElementById('gantt-date-header');
    const cronogramaArea = document.getElementById('gantt-cronograma-area');
    if (ganttCustom && dateHeader && cronogramaArea) {
        ganttCustom.addEventListener('scroll', function () {
            dateHeader.scrollLeft = ganttCustom.scrollLeft;
            cronogramaArea.scrollLeft = ganttCustom.scrollLeft;
        });
    }

    // Pan/drag horizontal no Gantt
    (function () {
        const ganttCustom = document.getElementById('gantt-custom');
        let isDown = false;
        let startX, scrollLeft;
        if (ganttCustom) {
            ganttCustom.addEventListener('mousedown', function (e) {
                if (e.button !== 0) return; // só botão esquerdo
                isDown = true;
                ganttCustom.classList.add('dragging');
                startX = e.pageX - ganttCustom.offsetLeft;
                scrollLeft = ganttCustom.scrollLeft;
                document.body.style.cursor = 'grabbing';
                e.preventDefault();
            });
            document.addEventListener('mousemove', function (e) {
                if (!isDown) return;
                const x = e.pageX - ganttCustom.offsetLeft;
                const walk = (x - startX) * -1; // sentido inverso
                ganttCustom.scrollLeft = scrollLeft + walk;
            });
            document.addEventListener('mouseup', function () {
                isDown = false;
                ganttCustom.classList.remove('dragging');
                document.body.style.cursor = '';
            });
            // Evita seleção de texto durante o drag
            ganttCustom.addEventListener('mouseleave', function () {
                isDown = false;
                ganttCustom.classList.remove('dragging');
                document.body.style.cursor = '';
            });
        }
    })();
</script>
{% endblock %} 